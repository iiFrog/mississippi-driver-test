<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mississippi Driver's Permit Prep (2025) - Final</title>
    <style>
        /* --- Core Variables --- */
        :root {
            --background-color: #f4f7f6;
            --text-color: #333;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --accent-color: #28a745;
            --accent-hover: #218838;
            --pdf-btn-color: #ffc107;
            --pdf-btn-hover: #e0a800;
            --container-bg: white;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --correct-bg: #d4edda;
            --correct-border: #c3e6cb;
            --correct-text: #155724;
            --incorrect-bg: #f8d7da;
            --incorrect-border: #f5c6cb;
            --incorrect-text: #721c24;
            --button-text-color: white;
            --pdf-button-text-color: #212529;
            --theme-toggle-bg: #e9ecef;
            --theme-toggle-hover: #ced4da;
            --link-color: var(--primary-color);
            --timer-select-bg: var(--theme-toggle-bg);
            --timer-select-border: var(--secondary-color);
            --progress-red: var(--incorrect-text);
            --progress-green: var(--correct-text);
            --score-red: #dc3545;
            --score-green: #28a745;
        }

        body.dark-mode {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --primary-color: #4dabf7;
            --primary-hover: #74c0fc;
            --secondary-color: #868e96;
            --secondary-hover: #adb5bd;
            --accent-color: #40c057;
            --accent-hover: #69db7c;
            --pdf-btn-color: #ffca2c;
            --pdf-btn-hover: #ffd54f;
            --container-bg: #1e1e1e;
            --card-bg: #2a2a2a;
            --card-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
            --correct-bg: #2a4a37;
            --correct-border: #345c47;
            --correct-text: #a3e9a4;
            --incorrect-bg: #5a2a2e;
            --incorrect-border: #723b40;
            --incorrect-text: #f5c6cb;
            --button-text-color: #e0e0e0;
            --pdf-button-text-color: #212529;
            --theme-toggle-bg: #343a40;
            --theme-toggle-hover: #495057;
            --link-color: var(--primary-color);
            --timer-select-bg: var(--theme-toggle-bg);
            --timer-select-border: var(--secondary-color);
            --progress-red: var(--incorrect-text);
            --progress-green: var(--correct-text);
             --score-red: #f5737e;
             --score-green: #69db7c;
        }

        /* --- Global Styles --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; line-height: 1.6; background-color: var(--background-color); color: var(--text-color); padding: 20px; padding-top: 70px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 950px; /* Wider for sidebar */ margin: 0 auto; background-color: var(--container-bg); border-radius: 8px; padding: 30px; box-shadow: var(--card-shadow); transition: background-color 0.3s, box-shadow 0.3s; }
        h1, h2, h3 { color: var(--primary-color); margin-bottom: 1em; text-align: center; }
        p { margin-bottom: 1em; }
        button, .button-link { display: inline-block; padding: 12px 25px; font-size: 1rem; font-weight: 600; color: var(--button-text-color); background-color: var(--primary-color); border: none; border-radius: 5px; cursor: pointer; text-align: center; transition: background-color 0.2s ease-in-out, transform 0.1s ease; text-decoration: none; vertical-align: middle; }
        button:hover, .button-link:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        button:disabled { background-color: var(--secondary-color); cursor: not-allowed; transform: none; }
        .button-secondary { background-color: var(--secondary-color); }
        .button-secondary:hover { background-color: var(--secondary-hover); }
        .button-accent { background-color: var(--accent-color); }
        .button-accent:hover { background-color: var(--accent-hover); }
        #btn-view-pdf { background-color: var(--pdf-btn-color); color: var(--pdf-button-text-color); }
        #btn-view-pdf:hover { background-color: var(--pdf-btn-hover); color: var(--pdf-button-text-color); }
        .hidden { display: none !important; }

        /* --- Fixed Top Elements --- */
        .fixed-controls { position: fixed; top: 15px; left: 15px; right: 15px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; width: calc(100% - 30px); pointer-events: none; }
        .timer-control { pointer-events: auto; }
        .timer-control label { font-size: 0.8rem; margin-right: 5px; color: var(--text-color); opacity: 0.8; }
        .timer-control select { font-size: 0.85rem; padding: 6px 8px; background-color: var(--timer-select-bg); color: var(--text-color); border: 1px solid var(--timer-select-border); border-radius: 5px; cursor: pointer; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .timer-control select:hover { border-color: var(--primary-color); }
        .theme-toggle-button { padding: 8px 12px; font-size: 0.85rem; background-color: var(--theme-toggle-bg); color: var(--text-color); border: 1px solid var(--secondary-color); border-radius: 5px; cursor: pointer; pointer-events: auto; transition: background-color 0.3s, color 0.3s; }
        .theme-toggle-button:hover { background-color: var(--theme-toggle-hover); }

        /* --- Main Menu --- */
        .main-menu { text-align: center; padding: 40px 0; }
        .main-menu h1 { margin-bottom: 40px; }
        .menu-buttons { display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .menu-buttons button, .menu-buttons .button-link { width: 90%; max-width: 320px; padding: 15px 20px; font-size: 1.1rem; box-sizing: border-box; }
        @media (min-width: 768px) { .menu-buttons { flex-direction: row; justify-content: center; flex-wrap: wrap; } .menu-buttons button, .menu-buttons .button-link { width: auto; flex-basis: calc(33.333% - 20px); min-width: 180px; } }
        .button-link { line-height: normal; }

        /* --- Study Guide --- */
         /* NEW: Container for sticky button positioning */
         .study-guide-container {
             position: relative; /* Needed for sticky positioning context */
         }
         #study-guide-content {
             max-height: 70vh; /* Limit height to enable scrolling */
             overflow-y: auto; /* Add scrollbar if content overflows */
             padding-right: 15px; /* Space for scrollbar */
             margin-bottom: 20px; /* Space below content before button */
         }
        .study-guide-entry { background-color: var(--card-bg); border-radius: 5px; padding: 15px; margin-bottom: 20px; box-shadow: var(--card-shadow); border-left: 4px solid var(--secondary-color); }
        .study-guide-entry p { margin-bottom: 0.5em; }
        .study-guide-question { font-weight: bold; margin-bottom: 0.7em; }
        .study-guide-answer { color: var(--correct-text); background-color: var(--correct-bg); border: 1px solid var(--correct-border); padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px; margin-bottom: 10px; }
        .study-guide-tip { font-style: italic; font-size: 0.9em; color: var(--secondary-color); margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--secondary-color); }
        body.dark-mode .study-guide-tip { color: var(--text-color); opacity: 0.8; }
         /* NEW: Sticky button container */
         .study-guide-nav {
             position: sticky;
             bottom: 20px; /* Stick near bottom */
             top: 70px; /* Stick below fixed header */
             text-align: center; /* Center button */
             padding: 10px 0; /* Add some padding */
             background-color: var(--container-bg); /* Match container background */
             z-index: 10; /* Ensure it's above scrolling content */
         }
          /* Adjust button margin if needed */
          .study-guide-nav button { margin-top: 0; }


        /* --- Test Options --- */
        .test-options { text-align: center; padding: 30px 0; }
        .test-options h2 { margin-bottom: 30px; }
        .test-options button { margin: 0 10px 10px 10px; }

        /* --- Test View --- */
        .test-view-layout { display: flex; gap: 30px; }
        .test-main-area { flex: 1; min-width: 0; display: flex; flex-direction: column; } /* Make main area a flex column */
        .test-sidebar { flex-basis: 160px; /* Slightly wider for score */ flex-shrink: 0; text-align: center; padding-top: 10px; display: block; /* Ensure it's displayed */ }
        #question-area { flex-grow: 1; } /* Allow question area to take vertical space */
        @media (max-width: 768px) { .test-view-layout { flex-direction: column; gap: 20px; } .test-sidebar { flex-basis: auto; padding-top: 0; margin-bottom: 20px; order: -1; } }
        .question-container { background-color: var(--card-bg); border-radius: 5px; padding: 20px; margin-bottom: 20px; box-shadow: var(--card-shadow); }
        .question-text { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; }
        .options-list { list-style: none; padding: 0; }
        .options-list li { background-color: var(--background-color); border: 1px solid var(--secondary-color); border-radius: 4px; padding: 12px 15px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .options-list li:hover:not(.disabled) { border-color: var(--primary-color); background-color: color-mix(in srgb, var(--background-color) 80%, var(--primary-color) 20%); }
        .options-list li.correct { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; color: var(--correct-text) !important; font-weight: bold; cursor: default; }
        .options-list li.incorrect { background-color: var(--incorrect-bg) !important; border-color: var(--incorrect-border) !important; color: var(--incorrect-text) !important; font-weight: bold; cursor: default; }
        .options-list li.show-correct { border: 2px solid var(--correct-text) !important; background-color: color-mix(in srgb, var(--correct-bg) 90%, black 10%) !important; }
        .options-list li.disabled { cursor: default; opacity: 0.7; }
        .progress-container { text-align: center; margin-bottom: 20px; }
        .progress-indicator { font-weight: bold; color: var(--secondary-color); font-size: 1rem; }
        .percentage-indicator { font-size: 0.9rem; font-weight: normal; margin-top: 2px; }
        .percentage-indicator.low-score { color: var(--progress-red); }
        .percentage-indicator.high-score { color: var(--progress-green); }
        .feedback-message { text-align: center; margin-top: 15px; font-weight: bold; min-height: 1.2em; }
        .feedback-message.correct { color: var(--correct-text); }
        .feedback-message.incorrect { color: var(--incorrect-text); }
        .navigation-buttons { text-align: center; margin-top: auto; /* Push buttons to bottom */ padding-top: 25px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .navigation-buttons button { margin: 0; }
        .live-score-counter { font-size: 2.8rem; /* Even larger */ font-weight: bold; line-height: 1.1; color: var(--text-color); margin-top: 20px; /* Add space above */ display: block; /* Ensure display */ }
        .live-score-counter .score-value { transition: color 0.3s ease-in-out; }
        .live-score-counter .score-value.low-score { color: var(--score-red); }
        .live-score-counter .score-value.high-score { color: var(--score-green); }
        .live-score-label { font-size: 0.9rem; color: var(--secondary-color); display: block; margin-top: 5px; }

        /* --- Results View --- */
        .results-view { text-align: center; padding: 30px; }
        .final-score { font-size: 1.8rem; font-weight: bold; margin-bottom: 20px; }
        .final-score .correct-count { color: var(--accent-color); }
        .final-score .total-count { color: var(--text-color); }
        .score-message { font-size: 1.1rem; margin-bottom: 30px; }

        /* --- Responsive --- */
         @media (max-width: 600px) {
             body { padding: 10px; padding-top: 60px; }
             .container { padding: 15px; max-width: 100%; }
             .fixed-controls { top: 10px; left: 10px; right: 10px; width: calc(100% - 20px); }
             .timer-control label { display: none; }
             .timer-control select { font-size: 0.8rem; padding: 4px 6px;}
             .theme-toggle-button { padding: 6px 10px; font-size: 0.75rem; }
             h1 { font-size: 1.6rem; }
             h2 { font-size: 1.3rem; }
             button, .button-link { padding: 10px 20px; font-size: 0.9rem; }
             .menu-buttons button, .menu-buttons .button-link { font-size: 1rem; }
             .options-list li { padding: 10px 12px; }
             .final-score { font-size: 1.5rem; }
             .test-sidebar { margin-bottom: 30px; }
             .live-score-counter { font-size: 2.2rem; }
             /* Adjust study guide scroll height */
             #study-guide-content { max-height: 60vh; }
             .study-guide-nav { bottom: 10px; } /* Stick closer to bottom */
         }
         @media (min-width: 601px) and (max-width: 768px) {
              .container { max-width: 95%; }
              .test-sidebar { flex-basis: 140px; }
              .live-score-counter { font-size: 2.2rem; }
         }

    </style>
</head>
<body>
    <div class="fixed-controls">
         <div class="timer-control">
             <label for="timer-select">Auto-Advance:</label>
             <select id="timer-select">
                 <option value="none">No Timer</option>
                 <option value="instant">Instant</option>
                 <option value="3000">3 Second Delay</option>
                 <option value="5000">5 Second Delay</option>
             </select>
         </div>
        <button class="theme-toggle-button" id="theme-toggle">Toggle Theme</button>
    </div>


    <div class="container">

        <div id="main-menu" class="main-menu">
             <h1>Mississippi Driver's Permit Prep</h1>
             <div class="menu-buttons">
                 <button id="btn-study-guide" class="button-accent">Study Guide</button>
                 <button id="btn-take-test">Take a Practice Test</button>
                 <a href="1.15.2025 Revised MDPS Driver's Manual.pdf" target="_blank" id="btn-view-pdf" class="button-link">
                     Drivers Manual
                 </a>
             </div>
        </div>

        <div id="study-guide-view" class="hidden study-guide-container"> <h2>Study Guide</h2>
             <div id="study-guide-content">
                 </div>
             <div class="study-guide-nav">
                  <button id="btn-back-to-menu-sg" class="button-secondary">Back to Menu</button>
             </div>
        </div>

        <div id="test-options" class="test-options hidden">
             <h2>Select Test Length</h2>
             <button data-length="10">10 Questions</button>
             <button data-length="20">20 Questions</button>
             <div style="margin-top: 30px;">
                 <button id="btn-back-to-menu-to" class="button-secondary">Back to Menu</button>
             </div>
        </div>

        <div id="test-view" class="hidden">
             <div class="test-view-layout">
                 <div class="test-main-area">
                     <div class="progress-container">
                         <div class="progress-indicator" id="progress">Question 1 / X</div>
                         <div class="percentage-indicator" id="percentage">(0% Correct)</div>
                     </div>
                     <div id="question-area">
                          <div class="question-container">
                             <div class="question-text" id="question-text">Loading...</div>
                             <ul class="options-list" id="options-list"></ul>
                             <div class="feedback-message" id="feedback-message"></div>
                          </div>
                     </div>
                      <div class="navigation-buttons">
                          <button id="next-question-btn" class="hidden">Next Question</button>
                          <button id="finish-quiz-btn" class="button-accent hidden">See Results</button>
                          <button id="quit-quiz-btn" class="button-secondary">Quit Quiz</button>
                      </div>
                 </div>
                 <div class="test-sidebar">
                      <div class="live-score-counter" id="live-score-counter">
                          <span class="score-value" id="live-score-value">0</span> / <span id="live-score-total">0</span>
                      </div>
                      <span class="live-score-label">Score</span>
                 </div>
             </div>
        </div>

        <div id="results-view" class="results-view hidden">
             <h2>Quiz Complete!</h2>
             <div class="final-score">
                 Your Score: <span id="correct-count" class="correct-count">0</span> / <span id="total-count" class="total-count">0</span>
             </div>
             <p class="score-message" id="score-message">Calculating...</p>
              <div class="navigation-buttons">
                 <button id="btn-retry-quiz" class="button-accent">Try Again (Same Length)</button>
                 <button id="btn-back-to-menu-results" class="button-secondary">Back to Menu</button>
             </div>
        </div>

    </div><script>
        // --- DOM Elements ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const timerSelect = document.getElementById('timer-select');
        const mainMenu = document.getElementById('main-menu');
        const studyGuideView = document.getElementById('study-guide-view');
        const testOptions = document.getElementById('test-options');
        const testView = document.getElementById('test-view');
        const resultsView = document.getElementById('results-view');
        const studyGuideContent = document.getElementById('study-guide-content');
        const progressIndicator = document.getElementById('progress');
        const percentageIndicator = document.getElementById('percentage');
        const questionText = document.getElementById('question-text');
        const optionsList = document.getElementById('options-list');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const finishQuizBtn = document.getElementById('finish-quiz-btn');
        const quitQuizBtn = document.getElementById('quit-quiz-btn');
        const correctCountSpan = document.getElementById('correct-count');
        const totalCountSpan = document.getElementById('total-count');
        const scoreMessage = document.getElementById('score-message');
        const liveScoreValue = document.getElementById('live-score-value');
        const liveScoreTotal = document.getElementById('live-score-total');

        // --- Data ---
        const allQuestions = [
            { question: "Under Mississippi law, when must you have a valid Driver's License or Learner's Permit?", options: { a: "Only when driving on interstates", b: "Only when driving outside city limits", c: "To operate any motor vehicle (except road/farm equipment) on streets or highways", d: "Only if you are under 21 years old" }, answer: "c", tip: "Think 'any vehicle, any public road' requires a license." },
            { question: "If you move to Mississippi, you must obtain a Mississippi driver's license within how many days?", options: { a: "30 days", b: "60 days", c: "90 days", d: "6 months" }, answer: "b", tip: "You get 2 months (60 days) to switch your license." },
            { question: "If you move to Mississippi, you must obtain a Mississippi license plate/tag within how many days?", options: { a: "30 days", b: "60 days", c: "90 days", d: "Immediately" }, answer: "a", tip: "Plates need changing faster than licenses - just 1 month (30 days)." },
            { question: "If you have a valid out-of-state driver's license when applying for a Mississippi license, which test is usually waived?", options: { a: "Vision Exam", b: "Road Test", c: "Computerized Exam", d: "Drug Test" }, answer: "c", tip: "They trust your previous state tested your knowledge (Computerized Exam)." },
            { question: "What is the minimum age to apply for a Regular Learner's Permit in Mississippi?", options: { a: "14", b: "15", c: "16", d: "17" }, answer: "b", tip: "Fifteen for a Permit." },
            { question: "How long must you generally hold a Learner's Permit before upgrading to a Regular Driver's License?", options: { a: "6 months", b: "9 months", c: "1 year", d: "2 years" }, answer: "c", tip: "One full year with a permit before getting the real license (unless you turn 17)." },
            { question: "When driving with a Regular Learner's Permit, who must accompany you?", options: { a: "Any licensed driver over 18", b: "A parent or guardian only", c: "A licensed driver aged 21 or older, occupying the seat next to you", d: "No one, if it's daylight hours" }, answer: "c", tip: "Permit driver needs an experienced adult (21+) right beside them." },
            { question: "To operate a motorcycle in Mississippi, what must you obtain in addition to your driver's license?", options: { a: "A Class D license", b: "A special permit renewed annually", c: "A Motorcycle Endorsement", d: "Proof of advanced rider training" }, answer: "c", tip: "Motorcycles need a special 'Endorsement' on your license." },
            { question: "Is wearing a crash helmet mandatory when operating or riding a motorcycle on public roads in Mississippi?", options: { a: "Yes, always", b: "No, it's optional", c: "Only if under 21", d: "Only on interstates" }, answer: "a", tip: "Helmets are NOT optional for anyone on a motorcycle in MS." },
            { question: "At what age can you apply directly for a Regular Driver's License (Class R) without previously holding a permit for a year?", options: { a: "16", b: "17 or older", c: "18 or older", d: "21 or older" }, answer: "b", tip: "At 17, you can skip the 1-year permit requirement." },
            { question: "How many proofs of residency are required for an original license application if you are 18 or older?", options: { a: "One", b: "Two", c: "Three", d: "None if you have a birth certificate" }, answer: "b", tip: "Need TWO ways to prove you live here (bills, lease, etc.)." },
            { question: "Which two documents are primary proofs of identification required for a license or permit?", options: { a: "School ID and Library Card", b: "Passport and Credit Card", c: "Social Security Card and Certified Birth Certificate", d: "Utility Bill and Voter Registration Card" }, answer: "c", tip: "The big two: official Birth Certificate and Social Security Card." },
            { question: "If you are under 18 applying for a license, what document must you provide regarding school?", options: { a: "Report Card", b: "Letter from a teacher", c: "Certification of Attendance form (not over 30 days old)", d: "Student ID card" }, answer: "c", tip: "Under 18 needs recent proof they're enrolled in school." },
            { question: "Beginning July 1, 2027, what additional documentation will be required for a driver's license?", options: { a: "Proof of vehicle ownership", b: "A letter of recommendation", c: "Proof of employment", d: "Documentation showing completion of a certified Driver's Education course" }, answer: "d", tip: "Future requirement: Must prove you took Driver's Ed." },
            { question: "What does Mississippi's Implied Consent Law mean?", options: { a: "You consent to let others drive your car.", b: "You consent to vehicle searches if stopped.", c: "By driving, you consent to a chemical test for BAC if arrested for DUI.", d: "You consent to higher insurance rates." }, answer: "c", tip: "'Implied Consent' = you agree to DUI testing just by driving here." },
            { question: "What is the minimum single person injury liability insurance coverage required in Mississippi?", options: { a: "$10,000", b: "$15,000", c: "$25,000", d: "$50,000" }, answer: "c", tip: "Remember 25/50/25 for insurance minimums (single/total injury/property)." },
            { question: "If you refuse a chemical test requested by law enforcement upon a DUI arrest, what is the administrative license suspension period for a first refusal?", options: { a: "30 days", b: "60 days", c: "90 days", d: "1 year" }, answer: "c", tip: "Refusing the DUI test = 90-day suspension first time." },
            { question: "What shape is a standard STOP sign?", options: { a: "Diamond", b: "Triangle", c: "Octagon", d: "Rectangle" }, answer: "c", tip: "STOP has 4 letters, but the sign has 8 sides (Octagon)." },
            { question: "What does a flashing red traffic light mean?", options: { a: "Stop and wait for green", b: "Slow down and proceed with caution", c: "The light is broken, proceed as if it were a yield sign", d: "The same as a stop sign; stop completely then proceed when safe" }, answer: "d", tip: "Flashing Red = Treat it like a STOP sign." },
            { question: "What does a solid yellow line on your side of the center line mean?", options: { a: "Passing is permitted with caution", b: "Passing is permitted only during daylight", c: "Passing is prohibited", d: "The lane is ending" }, answer: "c", tip: "Solid Yellow on YOUR side = NO Passing." },
            { question: "When approaching an intersection with no traffic signs or signals, you should:", options: { a: "Speed up to clear the intersection quickly", b: "Assume you have the right-of-way", c: "Yield to approaching traffic, then proceed when safe", d: "Stop only if you see another vehicle" }, answer: "c", tip: "No signs? Yield to others already there or approaching, then go." },
            { question: "In a roundabout, which direction does traffic flow?", options: { a: "Clockwise", b: "Counterclockwise", c: "Both directions are allowed", d: "Depends on the size of the roundabout" }, answer: "b", tip: "Roundabouts always go LEFT (Counterclockwise)." },
            { question: "When entering a roundabout, who has the right-of-way?", options: { a: "Vehicles entering the roundabout", b: "Vehicles already circulating within the roundabout", c: "The vehicle to the right", d: "The largest vehicle" }, answer: "b", tip: "Yield to cars already IN the circle." },
            { question: "When are you required by law to use your headlights?", options: { a: "Only when it's completely dark", b: "Between sunset and sunrise and when visibility is poor (cannot see 500 ft ahead)", c: "Only during rain or fog", d: "Whenever you are driving over 45 mph" }, answer: "b", tip: "Headlights on from sunset to sunrise, AND when you can't see 500 ft." },
            { question: "When approaching an oncoming vehicle at night, you must dim your headlights (use low beams) when you are within:", options: { a: "100 feet", b: "300 feet", c: "500 feet", d: "1000 feet" }, answer: "c", tip: "Dim brights 500 ft before meeting another car." },
            { question: "When following another vehicle at night, you must use low beams when you are within:", options: { a: "200 feet", b: "300 feet", c: "500 feet", d: "700 feet" }, answer: "c", tip: "Use low beams when following within 500 ft." },
            { question: "Mississippi law requires _______ to wear a properly fastened seat belt in a passenger motor vehicle.", options: { a: "Only the driver", b: "Only front seat occupants", c: "Only passengers under 18", d: "The driver and all passengers (front and back seats)" }, answer: "d", tip: "Seat belts for EVERYONE, front and back." },
            { question: "Children under _____ years old must be secured in a child passenger restraint device (car seat).", options: { a: "Two", b: "Three", c: "Four", d: "Five" }, answer: "c", tip: "Car seat required until age FOUR." },
            { question: "When encountering a stopped school bus with flashing red lights and stop arm extended on an undivided roadway, you must:", options: { a: "Slow down and pass carefully", b: "Stop regardless of your direction of travel", c: "Stop only if you are behind the bus", d: "Honk to alert children" }, answer: "b", tip: "Stopped school bus (flashing red) on undivided road? BOTH directions STOP." },
            { question: "When an emergency vehicle approaches displaying flashing lights and/or sounding a siren, what should you do?", options: { a: "Speed up to get out of the way", b: "Stop immediately in your lane", c: "Pull over to the right edge of the road and stop", d: "Follow the emergency vehicle closely" }, answer: "c", tip: "Emergency vehicle = Pull RIGHT and STOP." },
            { question: "When merging onto an interstate highway from an acceleration lane, you should:", options: { a: "Stop at the end of the ramp before merging", b: "Merge at a speed significantly slower than traffic", c: "Adjust your speed to match the flow of traffic and merge safely", d: "Force your way into traffic immediately" }, answer: "c", tip: "Use acceleration lane to MATCH speed, then merge." },
            { question: "Is it legal to litter from your vehicle in Mississippi?", options: { a: "Yes, if it's biodegradable", b: "Yes, but only on rural roads", c: "No, it is illegal and subject to fines", d: "Only small items are permitted" }, answer: "c", tip: "Littering = Illegal and fines. Keep MS beautiful!" },
            { question: "According to Mississippi law, when riding on public roads, a bicycle is considered a:", options: { a: "Pedestrian", b: "Toy", c: "Vehicle", d: "Road hazard" }, answer: "c", tip: "Bikes have the same rights/rules as VEHICLES on the road." },
            { question: "When passing a bicyclist traveling in the same direction, drivers must leave a safe distance of at least:", options: { a: "One foot", b: "Two feet", c: "Three feet", d: "Five feet" }, answer: "c", tip: "Give bikes at least THREE feet of space when passing." },
            { question: "Why should you avoid driving in a large truck's \"No-Zones\" (blind spots)?", options: { a: "It saves fuel", b: "The truck driver cannot see you", c: "It's only illegal on interstates", d: "It causes wind turbulence" }, answer: "b", tip: "Truck 'No-Zones' = Blind Spots. If you can't see their mirrors, they can't see you." },
            { question: "If a large truck is signaling a right turn, why should you avoid passing it on the right?", options: { a: "It's always illegal to pass on the right", b: "The truck might swing wide to the left before turning right", c: "The truck driver might change their mind", d: "You might block their view" }, answer: "b", tip: "Trucks swing WIDE for turns. Don't get caught on the inside of a right turn." },
            { question: "Parking is not allowed within how many feet of a fire hydrant?", options: { a: "5 feet", b: "10 feet", c: "15 feet", d: "20 feet" }, answer: "b", tip: "No parking within 10 feet of a fire hydrant." },
            { question: "When parking uphill next to a curb, which way should you turn your front wheels?", options: { a: "Straight ahead", b: "Towards the curb", c: "Away from the curb", d: "It doesn't matter" }, answer: "c", tip: "Up-Hill Curb -> Turn Wheels AWAY (Up, Up, and Away!). All others towards curb/edge." },
            { question: "What is one of the leading causes of accidents mentioned in the manual?", options: { a: "Poor road conditions", b: "Vehicle malfunctions", c: "Distracted driving", d: "Bad weather" }, answer: "c", tip: "Distracted driving (like texting) is a MAJOR cause of crashes." }
        ];

        // --- State Variables ---
        let currentView = 'main-menu';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedTestLength = 0;
        let autoAdvanceDelay = 'none';
        let autoAdvanceTimeout = null;

        // --- Functions ---
        function switchView(viewId) {
            mainMenu.classList.add('hidden');
            studyGuideView.classList.add('hidden');
            testOptions.classList.add('hidden');
            testView.classList.add('hidden');
            resultsView.classList.add('hidden');
            if (autoAdvanceTimeout) { clearTimeout(autoAdvanceTimeout); autoAdvanceTimeout = null; }
            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                viewToShow.classList.remove('hidden');
                currentView = viewId;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                console.error("View not found:", viewId);
                mainMenu.classList.remove('hidden');
                currentView = 'main-menu';
            }
        }

        function populateStudyGuide() {
             studyGuideContent.innerHTML = '';
             allQuestions.forEach(q => {
                 const entry = document.createElement('div');
                 entry.classList.add('study-guide-entry');
                 const questionP = document.createElement('p');
                 questionP.classList.add('study-guide-question');
                 questionP.textContent = q.question;
                 entry.appendChild(questionP);
                 const answerP = document.createElement('p');
                 const answerSpan = document.createElement('span');
                 answerSpan.classList.add('study-guide-answer');
                 answerSpan.textContent = `Answer: ${q.options[q.answer]}`;
                 answerP.appendChild(answerSpan);
                 entry.appendChild(answerP);
                 if (q.tip) {
                     const tipP = document.createElement('p');
                     tipP.classList.add('study-guide-tip');
                     tipP.textContent = `Memory Tip: ${q.tip}`;
                     entry.appendChild(tipP);
                 }
                 studyGuideContent.appendChild(entry);
             });
        }

        function startQuiz(numQuestions) {
            selectedTestLength = numQuestions;
            let shuffled = [...allQuestions];
            shuffleArray(shuffled);
            quizQuestions = shuffled.slice(0, selectedTestLength);
            currentQuestionIndex = 0;
            score = 0;
            liveScoreValue.textContent = score;
            liveScoreTotal.textContent = quizQuestions.length;
            liveScoreValue.className = 'score-value low-score';
            percentageIndicator.textContent = `(0% Correct)`;
            percentageIndicator.className = 'percentage-indicator low-score';
            switchView('test-view');
            displayQuestion();
            nextQuestionBtn.classList.add('hidden');
            finishQuizBtn.classList.add('hidden');
            quitQuizBtn.classList.remove('hidden');
        }

        function displayQuestion() {
            if (autoAdvanceTimeout) { clearTimeout(autoAdvanceTimeout); autoAdvanceTimeout = null; }
            if (currentQuestionIndex >= quizQuestions.length) { showResults(); return; }
            const question = quizQuestions[currentQuestionIndex];
            progressIndicator.textContent = `Question ${currentQuestionIndex + 1} / ${quizQuestions.length}`;
             const questionsAttemptedSoFar = currentQuestionIndex;
             let currentPercentage = 0;
             if (questionsAttemptedSoFar > 0) { currentPercentage = Math.round((score / questionsAttemptedSoFar) * 100); }
             percentageIndicator.textContent = `(${currentPercentage}% Correct)`;
             if (currentPercentage < 50) { percentageIndicator.className = 'percentage-indicator low-score'; }
             else { percentageIndicator.className = 'percentage-indicator high-score'; }
            questionText.textContent = question.question;
            optionsList.innerHTML = '';
            feedbackMessage.textContent = '';
            feedbackMessage.className = 'feedback-message';
            nextQuestionBtn.classList.add('hidden');
            finishQuizBtn.classList.add('hidden');
            for (const key in question.options) {
                const li = document.createElement('li');
                li.textContent = question.options[key];
                li.dataset.key = key;
                li.addEventListener('click', handleOptionClick);
                optionsList.appendChild(li);
            }
            quitQuizBtn.disabled = false;
        }

        function handleOptionClick(event) {
            if (autoAdvanceTimeout) { clearTimeout(autoAdvanceTimeout); autoAdvanceTimeout = null; }
            const selectedLi = event.target;
            const selectedKey = selectedLi.dataset.key;
            const question = quizQuestions[currentQuestionIndex];
            const correctKey = question.answer;
            const allOptions = optionsList.querySelectorAll('li');
            allOptions.forEach(li => {
                li.removeEventListener('click', handleOptionClick);
                li.classList.add('disabled');
                if (selectedKey !== correctKey && li.dataset.key === correctKey) { li.classList.add('show-correct'); }
            });
            if (selectedKey === correctKey) {
                selectedLi.classList.add('correct');
                feedbackMessage.textContent = "Correct!";
                feedbackMessage.className = 'feedback-message correct';
                score++;
            } else {
                selectedLi.classList.add('incorrect');
                feedbackMessage.textContent = `Incorrect. The correct answer was: ${question.options[correctKey]}`;
                feedbackMessage.className = 'feedback-message incorrect';
            }
            liveScoreValue.textContent = score;
            const scorePercentage = (score / quizQuestions.length) * 100;
            if (scorePercentage < 50) { liveScoreValue.className = 'score-value low-score'; }
            else { liveScoreValue.className = 'score-value high-score'; }
             const currentPercentage = Math.round((score / (currentQuestionIndex + 1)) * 100);
             percentageIndicator.textContent = `(${currentPercentage}% Correct)`;
             if (currentPercentage < 50) { percentageIndicator.className = 'percentage-indicator low-score'; }
             else { percentageIndicator.className = 'percentage-indicator high-score'; }
            const isLastQuestion = currentQuestionIndex >= quizQuestions.length - 1;
            const nextAction = isLastQuestion ? showResults : nextQuestion;
            if (autoAdvanceDelay === 'none') {
                if (isLastQuestion) { finishQuizBtn.classList.remove('hidden'); }
                else { nextQuestionBtn.classList.remove('hidden'); }
            } else if (autoAdvanceDelay === 'instant') {
                autoAdvanceTimeout = setTimeout(nextAction, 250);
            } else {
                autoAdvanceTimeout = setTimeout(nextAction, parseInt(autoAdvanceDelay));
            }
            quitQuizBtn.disabled = true;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function showResults() {
            correctCountSpan.textContent = score;
            totalCountSpan.textContent = quizQuestions.length;
            const percentage = quizQuestions.length > 0 ? Math.round((score / quizQuestions.length) * 100) : 0;
            if (percentage >= 80) { scoreMessage.textContent = "Great job! You passed."; }
            else if (percentage >= 60) { scoreMessage.textContent = "Good effort, but review the material more."; }
            else { scoreMessage.textContent = "Looks like you need more practice. Keep studying!"; }
            switchView('results-view');
        }

        function shuffleArray(array) {
             for (let i = array.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [array[i], array[j]] = [array[j], array[i]];
             }
        }

        // --- Event Listeners ---
        themeToggleBtn.addEventListener('click', () => {
             document.body.classList.toggle('dark-mode');
             const isDarkMode = document.body.classList.contains('dark-mode');
             localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
             themeToggleBtn.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
        });

         timerSelect.addEventListener('change', (e) => {
             autoAdvanceDelay = e.target.value;
             localStorage.setItem('timerSetting', autoAdvanceDelay);
             if (currentView === 'test-view') { // Only affect button if test is active
                 const questionAnswered = !optionsList.querySelector('li:not(.disabled)'); // Check if question was already answered
                 if (autoAdvanceDelay === 'none') {
                     // If timer turned off AND question is answered, show manual button
                     if (questionAnswered) {
                         if (currentQuestionIndex < quizQuestions.length - 1) { nextQuestionBtn.classList.remove('hidden'); }
                         else { finishQuizBtn.classList.remove('hidden'); }
                     }
                 } else {
                     // If timer turned on, hide manual buttons
                     nextQuestionBtn.classList.add('hidden');
                     finishQuizBtn.classList.add('hidden');
                 }
             }
         });

        document.getElementById('btn-study-guide').addEventListener('click', () => { populateStudyGuide(); switchView('study-guide-view'); });
        document.getElementById('btn-take-test').addEventListener('click', () => switchView('test-options'));
        document.getElementById('btn-back-to-menu-sg').addEventListener('click', () => switchView('main-menu'));
        document.getElementById('btn-back-to-menu-to').addEventListener('click', () => switchView('main-menu'));
        document.getElementById('btn-back-to-menu-results').addEventListener('click', () => switchView('main-menu'));

        testOptions.querySelectorAll('button[data-length]').forEach(button => {
            button.addEventListener('click', (e) => {
                const length = parseInt(e.target.dataset.length, 10);
                startQuiz(length);
            });
        });

        nextQuestionBtn.addEventListener('click', nextQuestion);
        finishQuizBtn.addEventListener('click', showResults);
        quitQuizBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to quit the quiz? Your progress will be lost.")) {
                switchView('main-menu');
            }
        });
        document.getElementById('btn-retry-quiz').addEventListener('click', () => {
            startQuiz(selectedTestLength);
        });

        // --- Initial Load ---
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggleBtn.textContent = 'Light Mode'; }
        else { themeToggleBtn.textContent = 'Dark Mode'; }
        const savedTimer = localStorage.getItem('timerSetting');
        if (savedTimer && ['none', 'instant', '3000', '5000'].includes(savedTimer)) { timerSelect.value = savedTimer; autoAdvanceDelay = savedTimer; }
        else { timerSelect.value = 'none'; autoAdvanceDelay = 'none'; }
        switchView('main-menu');

    </script>

</body>
</html>
